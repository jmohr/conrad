<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>test_query.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>test_query.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">nose.tools</span> <span class="kn">import</span> <span class="n">raises</span>

<span class="kn">import</span> <span class="nn">conrad</span><span class="o">,</span> <span class="nn">conrad.db</span>
<span class="kn">from</span> <span class="nn">conrad</span> <span class="kn">import</span> <span class="n">test</span>
<span class="kn">from</span> <span class="nn">conrad.query</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">QueryError</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">MockAdapter</span><span class="p">(</span><span class="n">conrad</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Adapter</span><span class="p">):</span>
    <span class="n">placeholder</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>
    <span class="n">lastrowid_function</span> <span class="o">=</span> <span class="s">&#39;LAST_ROW_ID()&#39;</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">escape</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">TestQuery</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">table_name</span> <span class="o">=</span> <span class="s">&#39;test_data&#39;</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>Create a test database with a few records in it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>self.database_file = tempfile.NamedTemporaryFile()
self.database_path = self.database_file.name
logger.debug('Creating test DB at path: %s' % self.database_path)
self.cxn = sqlite3.connect(self.database_path)
self.csr = self.cxn.cursor()</p>
<h1>Here we pull in one query per line, and execute each one in order.</h1>
<h1>This is because the SQLite cursor can only take one statement</h1>
<h1>at a time.</h1>
<p>create_schema = test.resource_file('test_schema.sql').readlines()
for line in create_schema:
<pre>self.csr.execute(line)
</pre>
def teardown(self):
Delete the database and close connections.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">csr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cxn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Unlinking test database: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_file</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>Test initializing the Query object, just to make sure</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>no aggregious exceptions are thrown."""
q = Query(self.table_name, adapter=MockAdapter)
assert q is not None</p>
<p>def test_query_types(self):
for qtype in ('SELECT', 'INSERT', 'UPDATE', 'DELETE'):
<pre>q = Query(self.table_name, qtype, adapter=MockAdapter)
assert qtype in q.sql
</pre>
def test_default_adapter(self):
q = Query(self.table_name)
assert issubclass(q.adapter, conrad.db.Adapter)</p>
<p>def test_select_stmt(self):
q = Query(self.table_name, adapter=MockAdapter)
self.csr.execute(q.sql)
results = self.csr.fetchall()
assert len(results) == 2</p>
<p>@raises(sqlite3.OperationalError)
def test_nonexist_table(self):
q = Query('bad_table', adapter=MockAdapter)
self.csr.execute(q.sql)</p>
<p>@raises(sqlite3.Warning)
def test_bad_sql(self):
q = Query('%s; DROP TABLE %s' % (self.table_name, self.table_name), adapter=MockAdapter)
self.csr.execute(q.sql)
self.csr.execute('SELECT * FROM %s' % self.table_name)
assert len(self.csr.fetchall()) == 2</p>
<p>@raises(QueryError)
def test_bad_qtype(self):
q = Query(self.table_name, 'BAD_ACTION')</p>
<p>def test_insert(self):
q = Query(self.table_name, 'INSERT')
q.set(name='New Guy 1')
q.set(age=31)
q.set(birthdate='12/12/1980')
q.set(active=True)
q.set(address='456 Sample Way')
q.set(email='newguy@example.net')
assert q.sql.startswith('INSERT INTO')
assert 'VALUES' in q.sql
assert 'name' in q.sql
assert 'address' in q.sql</p>
<p>def test_update(self):
q = Query(self.table_name, 'UPDATE').filter(name='Test Guy 1')
q.update(name='Fart Bama Sotero')
logger.debug('UPDATE SQL: %s' % q.sql)
assert q.sql.startswith('UPDATE')
assert 'name' in q.sql
assert 'Fart Bama Sotero' in q.arguments</p>
<p>def test_delete(self):
q = Query(self.table_name, 'DELETE').filter(name='Test Guy 1')
assert q.sql.startswith("DELETE FROM")
self.csr.execute(q.sql, q.arguments)
q = Query(self.table_name).filter(name='Test Guy 1')
self.csr.execute(q.sql, q.arguments)
res = self.csr.fetchall()
assert not res</p>
<p>def test_chaining(self):
q = Query(self.table_name).filter(name='Test Guy 2').filter(age=30)
assert 'name' in q.sql
assert 'age' in q.sql</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
